<!DOCTYPE html><html><head><title>easyble.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../app.coffee.html" class="source "><span class="base_path">. / </span><span class="file_name">app.coffee</span></a><a href="../../../libs/evothings/easyble/easyble.js.html" class="source selected"><span class="base_path">libs / evothings / easyble / </span><span class="file_name">easyble.js</span></a><a href="../../../libs/evothings/tisensortag/tisensortag.js.html" class="source "><span class="base_path">libs / evothings / tisensortag / </span><span class="file_name">tisensortag.js</span></a><a href="../../../libs/evothings/util/util.js.html" class="source "><span class="base_path">libs / evothings / util / </span><span class="file_name">util.js</span></a><a href="../../../pages.coffee.html" class="source "><span class="base_path">. / </span><span class="file_name">pages.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>easyble.js</h1><div class="filepath">libs/evothings/easyble/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>File: easyble.js<br />Description: Library for making BLE programming easier.<br />Author: Miki</p></div><div class="body"><p>Note: The object type called "device" below, is the "DeviceInfo"<br />object obtained by calling evothings.ble.startScan, enhanced with<br />additional properties and functions to allow easy access to<br />object methods. Properties are also added to the Characteristic<br />and Descriptor object. Added properties are prefixed with two<br />underscores.</p></div></div>
</td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">evothings</span><span class="p">)</span> <span class="p">{</span> <span class="nb">window</span><span class="p">.</span><span class="nx">evothings</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Object that holds BLE data and functions.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">easyble</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span>
<span class="p">{</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Main object in the EasyBLE API.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">easyble</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Set to true to report found devices only once,
<ul><li>set to false to report continuously.</li></ul></li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">reportDeviceOnce</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Internal properties and functions.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">internal</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Internal variable used to track reading of service data.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">readCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Table of discovered devices.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">knownDevices</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Table of connected devices.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Set to true to report found devices only once,
<ul><li>set to false to report continuously.</li></ul></li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">easyble</span><span class="p">.</span><span class="nx">reportDeviceOnce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">reportOnce</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">reportDeviceOnce</span> <span class="o">=</span> <span class="nx">reportOnce</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Start scanning for devices.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">easyble</span><span class="p">.</span><span class="nx">startScan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">easyble</span><span class="p">.</span><span class="nx">stopScan</span><span class="p">();</span>
    <span class="nx">internal</span><span class="p">.</span><span class="nx">knownDevices</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">startScan</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span>
    <span class="p">{</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Check if we already have got the device.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">existingDevice</span> <span class="o">=</span> <span class="nx">internal</span><span class="p">.</span><span class="nx">knownDevices</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">address</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">existingDevice</span><span class="p">)</span>
      <span class="p">{</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Do not report device again if flag is set.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">reportDeviceOnce</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Flag not set, report device again.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">existingDevice</span><span class="p">.</span><span class="nx">rssi</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">rssi</span><span class="p">;</span>
        <span class="nx">existingDevice</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">win</span><span class="p">(</span><span class="nx">existingDevice</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>New device, add to known devices.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">internal</span><span class="p">.</span><span class="nx">knownDevices</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">address</span><span class="p">]</span> <span class="o">=</span> <span class="nx">device</span><span class="p">;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Add methods to the device info object.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">internal</span><span class="p">.</span><span class="nx">addMethodsToDeviceObject</span><span class="p">(</span><span class="nx">device</span><span class="p">);</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Call callback function with device info.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">win</span><span class="p">(</span><span class="nx">device</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Stop scanning for devices.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">easyble</span><span class="p">.</span><span class="nx">stopScan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">stopScan</span><span class="p">();</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Close all connected devices.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">easyble</span><span class="p">.</span><span class="nx">closeConnectedDevices</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">device</span> <span class="o">=</span> <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="nx">device</span> <span class="o">&amp;&amp;</span> <span class="nx">device</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Add functions to the device object to allow calling them
<ul><li>in an object-oriented style.</li></ul></li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">addMethodsToDeviceObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span>
  <span class="p">{</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Connect to the device.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">connectToDevice</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Close the device.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span> <span class="o">&amp;&amp;</span> <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Read devices RSSI. Device must be connected.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">readRSSI</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">rssi</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Read all service info for the specified service UUIDs.
     * @param serviceUUIDs - array of UUID strings
     * @param win - success callback
     * @param fail - error callback
     * If serviceUUIDs is null, info for all services is read
     * (this can be time-consuming compared to reading a
     * selected number of services).</li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">readServices</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">serviceUUIDs</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">readServices</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">serviceUUIDs</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Read value of characteristic.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">readCharacteristic</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">readCharacteristic</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Read value of descriptor.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">readDescriptor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">readDescriptor</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Write value of characteristic.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">writeCharacteristic</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">writeCharacteristic</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Write value of descriptor.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">writeDescriptor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">writeDescriptor</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Subscribe to characteristic value updates.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">enableNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">enableNotification</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Unsubscribe from characteristic updates.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">device</span><span class="p">.</span><span class="nx">disableNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">internal</span><span class="p">.</span><span class="nx">disableNotification</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>Connect to a device.</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">connectToDevice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connectInfo</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">connectInfo</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">// connected</span>
      <span class="p">{</span>
        <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span> <span class="o">=</span> <span class="nx">connectInfo</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">;</span>
        <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">address</span><span class="p">]</span> <span class="o">=</span> <span class="nx">device</span><span class="p">;</span>

        <span class="nx">win</span><span class="p">(</span><span class="nx">device</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">connectInfo</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// disconnected</span>
      <span class="p">{</span>
        <span class="nx">internal</span><span class="p">.</span><span class="nx">connectedDevices</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>TODO: How to signal disconnect?
Call error callback?
Additional callback? (connect, disconnect, fail)
Additional parameter on win callback with connect state?
(Last one is the best option I think).</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">fail</span> <span class="o">&amp;&amp;</span> <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Obtain device services, them read characteristics and descriptors
<ul><li>for the services with the given uuid(s).</li>
<li>If serviceUUIDs is null, info is read for all services.</li></ul></li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">readServices</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">serviceUUIDs</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Read services.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">services</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">services</span><span class="p">)</span>
      <span class="p">{</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Array that stores services.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">device</span><span class="p">.</span><span class="nx">__services</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">services</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">services</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">__services</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">service</span><span class="p">);</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">service</span><span class="p">.</span><span class="nx">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">service</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">internal</span><span class="p">.</span><span class="nx">readCharacteristicsForServices</span><span class="p">(</span>
          <span class="nx">device</span><span class="p">,</span> <span class="nx">serviceUUIDs</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><ul>
<li>Read characteristics and descriptors for the services with the given uuid(s).
<ul><li>If serviceUUIDs is null, info for all services are read.</li>
<li>Internal function.</li></ul></li>
</ul></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">internal</span><span class="p">.</span><span class="nx">readCharacteristicsForServices</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">serviceUUIDs</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">characteristicsCallbackFun</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
    <span class="p">{</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>Array with characteristics for service.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">service</span><span class="p">.</span><span class="nx">__characteristics</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristics</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">--</span><span class="nx">readCounter</span><span class="p">;</span> <span class="c1">// Decrements the count added by services.</span>
        <span class="nx">readCounter</span> <span class="o">+=</span> <span class="nx">characteristics</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">characteristics</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">characteristic</span> <span class="o">=</span> <span class="nx">characteristics</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">service</span><span class="p">.</span><span class="nx">__characteristics</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">characteristic</span><span class="p">);</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristic</span><span class="p">.</span><span class="nx">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">characteristic</span><span class="p">;</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Read descriptors for characteristic.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">descriptors</span><span class="p">(</span>
            <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
            <span class="nx">characteristic</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
            <span class="nx">descriptorsCallbackFun</span><span class="p">(</span><span class="nx">characteristic</span><span class="p">),</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">descriptorsCallbackFun</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">characteristic</span><span class="p">)</span>
    <span class="p">{</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>Array with descriptors for characteristic.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">characteristic</span><span class="p">.</span><span class="nx">__descriptors</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">descriptors</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">--</span><span class="nx">readCounter</span><span class="p">;</span> <span class="c1">// Decrements the count added by characteristics.</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">descriptors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="nx">descriptors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">characteristic</span><span class="p">.</span><span class="nx">__descriptors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">descriptor</span><span class="p">);</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristic</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">descriptor</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nx">readCounter</span><span class="p">)</span>
        <span class="p">{</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Everything is read.</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">win</span><span class="p">(</span><span class="nx">device</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">};</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Initialize read counter.</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">readCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nx">serviceUUIDs</span><span class="p">)</span>
    <span class="p">{</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>Read info for service UUIDs.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">readCounter</span> <span class="o">=</span> <span class="nx">serviceUUIDs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">serviceUUIDs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">serviceUUIDs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">uuid</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">service</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Service not found: &#39;</span> <span class="o">+</span> <span class="nx">uuid</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>Read characteristics for service. Will also read descriptors.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">characteristics</span><span class="p">(</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
          <span class="nx">service</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
          <span class="nx">characteristicsCallbackFun</span><span class="p">(</span><span class="nx">service</span><span class="p">),</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>Read info for all services.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">readCounter</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__services</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__services</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span>
      <span class="p">{</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>Read characteristics for service. Will also read descriptors.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__services</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">characteristics</span><span class="p">(</span>
          <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
          <span class="nx">service</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
          <span class="nx">characteristicsCallbackFun</span><span class="p">(</span><span class="nx">service</span><span class="p">),</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">readCharacteristic</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">characteristic</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">characteristic</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Characteristic not found: &#39;</span> <span class="o">+</span> <span class="nx">characteristicUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">readCharacteristic</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">characteristic</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">win</span><span class="p">,</span>
      <span class="nx">fail</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">readDescriptor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">descriptorUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">descriptor</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Descriptor not found: &#39;</span> <span class="o">+</span> <span class="nx">descriptorUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">readDescriptor</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">value</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">()</span>
      <span class="p">{</span>
        <span class="nx">win</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">writeCharacteristic</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">characteristic</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">characteristic</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Characteristic not found: &#39;</span> <span class="o">+</span> <span class="nx">characteristicUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">writeCharacteristic</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">characteristic</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">value</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">()</span>
      <span class="p">{</span>
        <span class="nx">win</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">writeDescriptor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">descriptorUUID</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">descriptorUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">descriptor</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Descriptor not found: &#39;</span> <span class="o">+</span> <span class="nx">descriptorUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">writeDescriptor</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">descriptor</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">value</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">()</span>
      <span class="p">{</span>
        <span class="nx">win</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">fail</span><span class="p">(</span><span class="nx">errorCode</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">enableNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">characteristic</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">characteristic</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Characteristic not found: &#39;</span> <span class="o">+</span> <span class="nx">characteristicUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">enableNotification</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">characteristic</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">win</span><span class="p">,</span>
      <span class="nx">fail</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">internal</span><span class="p">.</span><span class="nx">disableNotification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">device</span><span class="p">,</span> <span class="nx">characteristicUUID</span><span class="p">,</span> <span class="nx">win</span><span class="p">,</span> <span class="nx">fail</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">characteristic</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">__uuidMap</span><span class="p">[</span><span class="nx">characteristicUUID</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">characteristic</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Characteristic not found: &#39;</span> <span class="o">+</span> <span class="nx">characteristicUUID</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">disableNotification</span><span class="p">(</span>
      <span class="nx">device</span><span class="p">.</span><span class="nx">deviceHandle</span><span class="p">,</span>
      <span class="nx">characteristic</span><span class="p">.</span><span class="nx">handle</span><span class="p">,</span>
      <span class="nx">win</span><span class="p">,</span>
      <span class="nx">fail</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a href="#section-45" class="pilcrow">&#182;</a></div><p>For debugging. Example call:
easyble.printObject(device, console.log);</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">easyble</span><span class="p">.</span><span class="nx">printObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">printFun</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">indent</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prop</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="nx">printFun</span><span class="p">(</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">prop</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">);</span>
            <span class="nx">print</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="nx">printFun</span><span class="p">(</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">prop</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">easyble</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">evothings</span><span class="p">.</span><span class="nx">ble</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">easyble</span><span class="p">;</span>
<span class="p">})();</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Apr 26 2015 14:18:06 GMT+1000 (ChST)  </div><div id="projectname"><a href="../../../index.html">Stag App</a></div></div></body></html>