<!DOCTYPE html>

<html>
<head>
  <title>stagapp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="stagapp">stagapp</h1>
<p>vim: et:ts=2:sw=2:sts=2</p>
<h2 id="data-handler-for-clinical-recording-of-sensortag-data">data handler for clinical recording of SensorTag data</h2>
<p>SensorTag object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Backbone = <span class="hljs-built_in">require</span> (<span class="hljs-string">'backbone'</span>)
_ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
<span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/dbg/console'</span>)
Backbone.$ = $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>)
Seen = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/dbg/seen'</span>)
pages = <span class="hljs-built_in">require</span> <span class="hljs-string">'./pages.coffee'</span>


evothings = <span class="hljs-built_in">window</span>.evothings ={}
evothings.util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/evothings/util/util'</span>).util
evothings.easyble =<span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/evothings/easyble/easyble'</span>).easyble
evothings.tisensortag=<span class="hljs-built_in">require</span>(<span class="hljs-string">'./libs/evothings/tisensortag/tisensortag'</span>).tisensortag
sensortag = evothings.tisensortag.createInstance()

recording = <span class="hljs-literal">false</span>
connected = <span class="hljs-literal">false</span>
reading = <span class="hljs-literal">undefined</span>
readings = <span class="hljs-literal">undefined</span>
calibrating = <span class="hljs-literal">false</span>
calibrate = <span class="hljs-literal">false</span>

rawSession = Backbone.Model.extend -&gt;
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">user</span>: <span class="hljs-string">''</span>
    <span class="hljs-attribute">patient</span>: <span class="hljs-string">''</span>
    <span class="hljs-attribute">testID</span>: <span class="hljs-string">''</span>
    <span class="hljs-attribute">hostUrl</span>: <span class="hljs-literal">undefined</span>
    <span class="hljs-attribute">deviceUUID</span>: <span class="hljs-string">''</span>

sessionInfo = <span class="hljs-keyword">new</span> rawSession</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="hardware">Hardware</h2>
<p>external communications to Hardware</p>
<p>set up the sensorTag and configure to recieve
accelerometer, magnetometer and gyro data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">initializeSensorTag</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Here sensors are set up.</p>
<p>If you wish to use only one or a few sensors, just set up
the ones you wish to use.</p>
<p>First parameter to sensor function is the callback function.
Several of the sensors take a millisecond update interval
as the second parameter.
Gyroscope takes the axes to enable as the third parameter:
1 to enable X axis only, 2 to enable Y axis only, 3 = X and Y,
4 = Z only, 5 = X and Z, 6 = Y and Z, 7 = X, Y and Z.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  connected = <span class="hljs-literal">false</span>
  sensortag.statusCallback(statusHandler)
  sensortag.errorCallback(errorHandler)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p> sensortag.keypressCallback(keypressHandler)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sensortag.accelerometerCallback(accelerometerHandler, <span class="hljs-number">100</span>)
  sensortag.magnetometerCallback(magnetometerHandler, <span class="hljs-number">100</span>)
  sensortag.gyroscopeCallback(gyroscopeHandler, <span class="hljs-number">100</span>, <span class="hljs-number">7</span>)
  sensortag.connectToClosestDevice()
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="section-view">section: View</h2>
<p>routines to control or coordinate with user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">templater</span> = <span class="hljs-params">(x, y, z, sensor=<span class="hljs-string">'unknown'</span>, unit=<span class="hljs-string">''</span>)</span> -&gt;</span>
  sensor + <span class="hljs-string">' x='</span> + (<span class="hljs-keyword">if</span> x &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + x.toFixed(<span class="hljs-number">2</span>) + unit + <span class="hljs-string">' -- '</span> + <span class="hljs-string">'y='</span> + (<span class="hljs-keyword">if</span> y &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + y.toFixed(<span class="hljs-number">2</span>) + unit + <span class="hljs-string">' -- '</span> + <span class="hljs-string">'z='</span> + (<span class="hljs-keyword">if</span> z &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + z.toFixed(<span class="hljs-number">2</span>) + unit
<span class="hljs-function">
<span class="hljs-title">pointFormat</span> = <span class="hljs-params">(p, unit =<span class="hljs-string">'v'</span>, precision=<span class="hljs-number">2</span>)</span> -&gt;</span>
  unit + <span class="hljs-string">' x='</span> + (<span class="hljs-keyword">if</span> p.x &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + p.x.toFixed(precision) + <span class="hljs-string">' -- '</span> + <span class="hljs-string">'y='</span> + (<span class="hljs-keyword">if</span> p.y &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + p.y.toFixed(precision) + <span class="hljs-string">' -- '</span> + <span class="hljs-string">'z='</span> + (<span class="hljs-keyword">if</span> p.z &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'+'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>) + p.z.toFixed(precision)
<span class="hljs-function"><span class="hljs-title">startRecording</span>= <span class="hljs-params">()</span> -&gt;</span>
  enterRecording()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startStop</span>= <span class="hljs-params">()</span> -&gt;</span>
  enterStop()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startDebug</span> = <span class="hljs-params">()</span> -&gt;</span>
  pageGen.activateButtons buttonModelDebugOn
  $(<span class="hljs-string">'#footer'</span>).show()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">stopDebug</span> = <span class="hljs-params">()</span> -&gt;</span>
  pageGen.activateButtons buttonModelDebugOff
  $(<span class="hljs-string">'#footer'</span>).hide()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startReset</span> = <span class="hljs-params">()</span> -&gt;</span>
  enterReset()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startUpload</span> = <span class="hljs-params">()</span> -&gt;</span>
  enterUpload()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startCalibrate</span> = <span class="hljs-params">()</span> -&gt;</span>
  enterCalibrate()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startAdmin</span> = <span class="hljs-params">()</span> -&gt;</span>
  enterAdmin()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">startLogout</span> = <span class="hljs-params">()</span> -&gt;</span>
  enterLogout()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">enterAdmin</span> = -&gt;</span>
  buttonCollection.admin = buttonModelLogout
  setButtons()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

aButtonModel = Backbone.Model.extend 
  <span class="hljs-attribute">defaults</span>: {
    <span class="hljs-attribute">active</span>: <span class="hljs-literal">false</span>
    <span class="hljs-attribute">func</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-attribute">text</span>: <span class="hljs-string">'--'</span>
    <span class="hljs-attribute">selector</span>: <span class="hljs-string">'button'</span>
  }


buttonModelDebugOn = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#debug'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">"Hide Log"</span>
  <span class="hljs-attribute">funct</span>: stopDebug
buttonModelDebugOff = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#debug'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">"Show Log"</span>
  <span class="hljs-attribute">funct</span>: startDebug
buttonModelActionRecord = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#action'</span>,
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Record'</span>,
  <span class="hljs-attribute">funct</span>: startRecording

buttonModelActionStop = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#action'</span>,
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Stop'</span>,
  <span class="hljs-attribute">funct</span>: startStop
    
buttonModelReset = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#reset'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Clear'</span>
  <span class="hljs-attribute">funct</span>: startReset

buttonModelUpload = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#upload'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Upload'</span>
  <span class="hljs-attribute">funct</span>: startUpload

buttonModelCalibrate = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#calibrate'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Calibrate'</span>
  <span class="hljs-attribute">funct</span>: startCalibrate

buttonModelAdmin = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#admin'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Log In'</span>
  <span class="hljs-attribute">funct</span>: startAdmin

buttonModelLogout = <span class="hljs-keyword">new</span> aButtonModel
  <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#admin'</span>
  <span class="hljs-attribute">text</span>: <span class="hljs-string">'Log out'</span>
  <span class="hljs-attribute">funct</span>: startLogout

buttonValueAdmin = buttonModelAdmin

buttonCollection = {
  <span class="hljs-attribute">admin</span>: buttonValueAdmin
  <span class="hljs-attribute">calibrate</span>: buttonModelCalibrate
  <span class="hljs-attribute">debug</span>: buttonModelDebugOn
  <span class="hljs-attribute">action</span>: buttonModelActionRecord
  <span class="hljs-attribute">upload</span>: buttonModelUpload
  <span class="hljs-attribute">reset</span>: buttonModelReset
  }
<span class="hljs-function">  

<span class="hljs-title">enterLogout</span> = <span class="hljs-params">()</span> -&gt;</span>
  sessionInfo.set(<span class="hljs-string">'password'</span>,<span class="hljs-string">''</span>)
  sessionInfo.set(<span class="hljs-string">'user'</span>,<span class="hljs-string">''</span>)
  sessionInfo.set(<span class="hljs-string">'patient'</span>,<span class="hljs-string">''</span>)
  sessionInfo.set(<span class="hljs-string">'testID'</span>,<span class="hljs-string">''</span>)  
  buttonValueAdmin = buttonModelAdmin
  pageGen.activateButtons buttonCollection
<span class="hljs-function">
  
<span class="hljs-title">setButtons</span> = -&gt;</span>
  pageGen.activateButtons buttonCollection
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">clearUserInterface</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Clear current values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  blank = <span class="hljs-string">'Waiting...'</span>
  $(<span class="hljs-string">'#StatusData'</span>).html <span class="hljs-string">'Ready to connect'</span>
  $(<span class="hljs-string">'#FirmwareData'</span>).html <span class="hljs-string">'?'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>$(‘#AccelerometerData’).html blank
$(‘#MagnetometerData’).html blank
$(‘#GyroscopeData’).html blank</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'#TotalReadings'</span>).html <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Reset screen color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setBackgroundColor <span class="hljs-string">'white'</span>
  buttonCollection.debug = buttonModelDebugOff
  pageGen.activateButtons buttonCollection
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">countReadings</span> = -&gt;</span>
  $(<span class="hljs-string">'#TotalReadings'</span>).html readings.length
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="section-data-structures">Section: Data Structures</h2>
<p>Routines to create and handle data structures and interfaces to them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
user = Backbone.Model.extend
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Text'</span>
    <span class="hljs-attribute">password</span>: <span class="hljs-string">'Password'</span>
    <span class="hljs-attribute">patientOnly</span>: <span class="hljs-string">'Boolean'</span>
host = Backbone.Model.extend
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">hostUrl</span>: <span class="hljs-string">'Text'</span>
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Text'</span>
test = Backbone.Model.extend
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">name</span>: <span class="hljs-string">"test 0"</span>
    <span class="hljs-attribute">Description</span>: <span class="hljs-string">"Test 0"</span>

userCollection = Backbone.Collection.extend
  <span class="hljs-attribute">model</span>: user
  <span class="hljs-attribute">url</span>: <span class="hljs-string">'/users'</span>

hostCollection = Backbone.Collection.extend
  <span class="hljs-attribute">model</span>: host
  <span class="hljs-attribute">url</span>:<span class="hljs-string">"/host_list.json"</span>

testCollection = Backbone.Collection.extend
  <span class="hljs-attribute">model</span>: test
  <span class="hljs-attribute">url</span>: <span class="hljs-string">"/tests_list.json"</span>
users = <span class="hljs-keyword">new</span> userCollection
users.push <span class="hljs-keyword">new</span> user(
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Jim'</span>
    <span class="hljs-attribute">password</span>: <span class="hljs-string">'Y'</span>
    <span class="hljs-attribute">patientOnly</span>: <span class="hljs-literal">false</span>
  )
users.push <span class="hljs-keyword">new</span> user(
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Harry'</span>
    <span class="hljs-attribute">password</span>: <span class="hljs-string">'Y'</span>
    <span class="hljs-attribute">patientOnly</span>: <span class="hljs-literal">false</span>
  )
users.push <span class="hljs-keyword">new</span> user(
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Sam'</span>
    <span class="hljs-attribute">password</span>: <span class="hljs-string">'Y'</span>
    <span class="hljs-attribute">patientOnly</span>: <span class="hljs-literal">true</span>
  )
users.push <span class="hljs-keyword">new</span> user(
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'Bob'</span>
    <span class="hljs-attribute">password</span>: <span class="hljs-string">'Y'</span>
    <span class="hljs-attribute">patientOnly</span>: <span class="hljs-literal">true</span>
  )

hosts = <span class="hljs-keyword">new</span> hostCollection
hosts.push <span class="hljs-keyword">new</span> host(
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'saal'</span>
  <span class="hljs-attribute">url</span>: <span class="hljs-string">'http://www.saal.org:3000'</span>
)
hosts.push <span class="hljs-keyword">new</span> host(
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'local'</span>
  <span class="hljs-attribute">url</span>: <span class="hljs-string">'http://192.168.1.200:3000'</span>
)
hosts.push <span class="hljs-keyword">new</span> host(
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'Cloud 9'</span>
  <span class="hljs-attribute">url</span>: <span class="hljs-string">'https://stagserv-jahbini.c9.io'</span>
)
tests = <span class="hljs-keyword">new</span> testCollection
tests.push <span class="hljs-keyword">new</span> test
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'test1'</span>
  <span class="hljs-attribute">Description</span>: <span class="hljs-string">'Test 1'</span>
  
tests.push <span class="hljs-keyword">new</span> test
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'test2'</span>
  <span class="hljs-attribute">Description</span>: <span class="hljs-string">'Test 2'</span>
  

adminData = Backbone.Model.extend
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">host</span>: hosts
    <span class="hljs-attribute">user</span>: users
    <span class="hljs-attribute">testIDs</span>: tests

admin = <span class="hljs-keyword">new</span> adminData
<span class="hljs-function">
<span class="hljs-title">initDataStructures</span> = -&gt;</span>
  rtemp = <span class="hljs-literal">undefined</span>
  reading = Backbone.Model.extend(
    <span class="hljs-attribute">defaults</span>:
      <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'gyro'</span>
    <span class="hljs-attribute">initialize</span>: <span class="hljs-function">-&gt;</span>
      d = <span class="hljs-keyword">new</span> Date
      <span class="hljs-property">@set</span> <span class="hljs-string">'time'</span>, d.getTime()
      <span class="hljs-keyword">return</span>
  )
  rtemp = Backbone.Collection.extend(
    <span class="hljs-attribute">model</span>: <span class="hljs-string">'reading'</span>
    <span class="hljs-attribute">initialize</span>: <span class="hljs-function">-&gt;</span>
      <span class="hljs-property">@on</span> <span class="hljs-string">'add'</span>, countReadings
      <span class="hljs-property">@on</span> <span class="hljs-string">'remove'</span>, countReadings
      <span class="hljs-property">@on</span> <span class="hljs-string">'reset'</span>, countReadings
      <span class="hljs-keyword">return</span>
  )
  readings = <span class="hljs-keyword">new</span> rtemp
  readings.push(
    <span class="hljs-keyword">new</span> reading <span class="hljs-attribute">raw</span>: [ <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'DebugOnly'</span>
    )
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="section-state-handlers">Section State Handlers</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">initAll</span> = -&gt;</span>
  rtemp = <span class="hljs-literal">undefined</span>
  setButtons()
  clearUserInterface()
  initDataStructures()
  $(<span class="hljs-string">'#TotalReadings'</span>).html <span class="hljs-string">'0'</span>
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="subsection-state-handlers-that-depend-on-the-view">subsection State handlers that depend on the View</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">keypressHandler</span> = <span class="hljs-params">(data)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  left = <span class="hljs-number">0</span>
  right = <span class="hljs-number">0</span>
  string = <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">switch</span> data[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">when</span> <span class="hljs-number">0</span>
      string = <span class="hljs-string">'          '</span>
    <span class="hljs-keyword">when</span> <span class="hljs-number">1</span>
      string = <span class="hljs-string">'     right'</span>
      right = <span class="hljs-number">1</span>
    <span class="hljs-keyword">when</span> <span class="hljs-number">2</span>
      string = <span class="hljs-string">'left      '</span>
      left = <span class="hljs-number">1</span>
    <span class="hljs-keyword">when</span> <span class="hljs-number">3</span>
      right = <span class="hljs-number">1</span>
      left = <span class="hljs-number">1</span>
      string = <span class="hljs-string">'   both   '</span>
  calibrate = left <span class="hljs-keyword">and</span> calibrating
  <span class="hljs-keyword">if</span> recording
    readings.push <span class="hljs-keyword">new</span> reading(
      <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'button'</span>
      <span class="hljs-attribute">left</span>: left
      <span class="hljs-attribute">right</span>: right)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update the value displayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(<span class="hljs-string">'KeypressData'</span>).html string
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">enterReset</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Reset only clears the data — does NOT disconnedt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reading = <span class="hljs-literal">false</span>
  readings = <span class="hljs-literal">null</span>
  recording = <span class="hljs-literal">false</span>
  initDataStructures()
  $(<span class="hljs-string">'#TotalReadings'</span>).html <span class="hljs-string">'0'</span>
  pageGen.deactivateButtons buttonModelReset,buttonModelUpload
  <span class="hljs-keyword">if</span> connected
    pageGen.activateButtons buttonModelActionRecord,buttonModelCalibrate
    pageGen.deactivateButtons buttonValueAdmin
  <span class="hljs-keyword">else</span>
    pageGen.activateButtons buttonValueAdmin
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">enterConnected</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>enable the recording button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  connected = <span class="hljs-literal">true</span>
  pageGen.deactivateButtons buttonValueAdmin
  pageGen.activateButtons buttonModelActionRecord,buttonModelCalibrate
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">enterCalibrating</span> = -&gt;</span>
  pageGen.deactivateButtons buttonModelRecord, buttonModelUpload
  pageGen.activateButtons {
    <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#calibrate'</span>
    <span class="hljs-attribute">text</span>: <span class="hljs-string">'Exit Calibrate'</span>
    <span class="hljs-attribute">funct</span>: exitCalibrating
  }
  calibrating = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">exitCalibrating</span> = -&gt;</span>
  calibrating = <span class="hljs-literal">false</span>
  pageGen.activateButtons buttonModelRecord, buttonModelCalibrate 
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">enterRecording</span> = -&gt;</span>
  pageGen.activateButtons buttonModelActionStop
  recording = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">enterStop</span> = -&gt;</span>
  pageGen.deactivateButtons {
    <span class="hljs-attribute">selector</span>: <span class="hljs-string">'#action'</span>
    <span class="hljs-attribute">text</span>: <span class="hljs-string">'recorded'</span>
    <span class="hljs-attribute">funct</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  }
  pageGen.activateButtons buttonModelUpload, buttonModelReset
  recording = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">enterUpload</span> = -&gt;</span>
  hopper = <span class="hljs-literal">undefined</span>
  brainDump = <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>   eliminate empty uploads per : <a href="https://github.com/jahbini/stagapp/issues/15">https://github.com/jahbini/stagapp/issues/15</a> */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> !readings.length
   <span class="hljs-keyword">return</span> 
  hostUrl= sessionInfo.get <span class="hljs-string">'hostUrl'</span>
  hopper = Backbone.Model.extend {
    <span class="hljs-attribute">url</span>: <span class="hljs-string">'/trajectory'</span>
    <span class="hljs-attribute">urlRoot</span>: hostUrl
  }
  <span class="hljs-built_in">console</span>?log <span class="hljs-string">'hostURL='</span> + hostURL
  <span class="hljs-built_in">console</span>?log sessionInfo
  alert(<span class="hljs-string">"Upload"</span>)
  alert(hostUrl)
  brainDump = <span class="hljs-keyword">new</span> hopper 

  brainDump.set(<span class="hljs-string">'readings'</span>,readings )
  brainDump.set(<span class="hljs-string">'deviceUUID'</span>,sessionInfo.get(<span class="hljs-string">'deviceUUID'</span>) )
  brainDump.set(<span class="hljs-string">'patientID'</span>,sessionInfo.get(<span class="hljs-string">'patient'</span>) )
  brainDump.set(<span class="hljs-string">'user'</span>,sessionInfo.get(<span class="hljs-string">'clinician'</span>) )

  brainDump.set(<span class="hljs-string">'password'</span>,sessionInfo.get(<span class="hljs-string">'password'</span>) )
  brainDump.set(<span class="hljs-string">'testID'</span>,sessionInfo.get(<span class="hljs-string">'testID'</span>) )
  brainDump.set(<span class="hljs-string">'hostUrl'</span>,sessionInfo.get(<span class="hljs-string">'hostUrl'</span>) )

  brainDump.save()
  pageGen.deactivateButtons buttonModelUpload, buttonModelReset
  readings.reset()
  enterConnected()
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3 id="subsection-state-handlers-that-depend-on-the-hardware">Subsection State Handlers that depend on the Hardware</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">statusHandler</span> = <span class="hljs-params">(status)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>.log status
  <span class="hljs-keyword">if</span> <span class="hljs-string">'Sensors online'</span> == status
    enterConnected()
  <span class="hljs-keyword">if</span> <span class="hljs-string">'Device data available'</span> == status
    $(<span class="hljs-string">'#FirmwareData'</span>).html sensortag.getFirmwareString()
    sessionInfo.set <span class="hljs-string">'deviceUUID'</span>, sensortag?.device?.address
    <span class="hljs-built_in">console</span>?.log sensortag?.device?.address
  $(<span class="hljs-string">'#StatusData'</span>).html status
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">errorHandler</span> = <span class="hljs-params">(error)</span> -&gt;</span>
  <span class="hljs-built_in">console</span>?log <span class="hljs-string">'Error: '</span> + error
  <span class="hljs-keyword">if</span> <span class="hljs-string">'disconnected'</span> == error
    connected = <span class="hljs-literal">false</span>
    clearUserInterface()</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If disconneted attempt to connect again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setTimeout (<span class="hljs-function">-&gt;</span>
      sensortag.connectToClosestDevice()
      <span class="hljs-keyword">return</span>
    ), <span class="hljs-number">1000</span>
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">calibratorAverage</span> = <span class="hljs-params">(dataCondition, calibrate, calibrating)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    tH = <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">if</span> dataCondition.dataHistory.grandTotal == <span class="hljs-literal">undefined</span>
      dataCondition.dataHistory.grandTotal = Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      dataCondition.dataHistory.grandAverage = Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      dataCondition.dataHistory.totalReadings = <span class="hljs-number">1</span>
    tH = dataCondition.dataHistory
    <span class="hljs-keyword">if</span> tH.totalReadings == <span class="hljs-number">1000</span>
      tH.grandTotal.subtract tH.grandAverage
      tH.totalReadings--
    tH.grandTotal.add dataCondition.curValue
    tH.totalReadings++
    tH.grandAverage = tH.grandTotal.copy().divide(tH.totalReadings)
    dataCondition.cookedValue = dataCondition.curValue.copy().subtract(tH.grandAverage)
  <span class="hljs-keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>console.log e.message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">split</span> = <span class="hljs-params">(raw, lo, hi)</span> -&gt;</span>
  raw - ((hi + lo) / <span class="hljs-number">2.0</span>)
<span class="hljs-function">
<span class="hljs-title">calibratorMid</span> = <span class="hljs-params">(dataCondition, calibrate, calibrating)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    tH = <span class="hljs-literal">undefined</span>
    <span class="hljs-keyword">if</span> dataCondition.dataHistory.max == <span class="hljs-literal">undefined</span>
      dataCondition.dataHistory.max = dataCondition.cookedValue.copy()
      dataCondition.dataHistory.min = dataCondition.cookedValue.copy()
    tH = dataCondition.dataHistory
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.x &gt; tH.max.x
      tH.max.x = dataCondition.cookedValue.x
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.y &gt; tH.max.y
      tH.max.y = dataCondition.cookedValue.y
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.z &gt; tH.max.z
      tH.max.z = dataCondition.cookedValue.z
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.x &lt; tH.min.x
      tH.min.x = dataCondition.cookedValue.x
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.y &lt; tH.min.y
      tH.min.y = dataCondition.cookedValue.y
    <span class="hljs-keyword">if</span> dataCondition.cookedValue.z &lt; tH.min.z
      tH.min.z = dataCondition.cookedValue.z
    dataCondition.cookedValue.x = split(dataCondition.cookedValue.x, tH.min.x, tH.max.x)
    dataCondition.cookedValue.y = split(dataCondition.cookedValue.y, tH.min.y, tH.max.y)
    dataCondition.cookedValue.z = split(dataCondition.cookedValue.z, tH.min.z, tH.max.z)
  <span class="hljs-keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>console.log e.message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">calibratorSmooth</span> = <span class="hljs-params">(dataCondition, calibrate, calibrating)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    <span class="hljs-keyword">if</span> dataCondition.dataHistory.runniongSum == <span class="hljs-literal">undefined</span>
      dataCondition.dataHistory.runningSum = dataCondition.cookedValue.copy()
    dataCondition.cookedValue = dataCondition.dataHistory.runningSum.multiply(<span class="hljs-number">0.75</span>).add(dataCondition.cookedValue.copy().multiply(<span class="hljs-number">0.25</span>)).copy()
  <span class="hljs-keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log e.message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h1 id="-readinghandler-">## readingHandler()</h1>
<h1 id="create-and-return-a-function-to-handle-a-sensor-s-new-data">create and return a function to handle a sensor’s new data</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">readingHandler</span> = <span class="hljs-params">(o)</span> -&gt;</span>
  dataCondition =
    <span class="hljs-attribute">curValue</span>: Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-attribute">cookedValue</span>: Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-attribute">dataHistory</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>if there is no calibration function, just use a null offset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> !o.calibrator
    o.calibrator = <span class="hljs-function"><span class="hljs-params">(d)</span> -&gt;</span>
      d.cookedValue = d.curValue
      <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">if</span> !o.units
    o.units = <span class="hljs-string">''</span>
  o.bias = Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  $(<span class="hljs-string">'#'</span> + o.debias).click -&gt;
    o.bias = o.cookedValue</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>console.log o</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span>
  (data) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>data points from Evothings library are Seen.Point NOT compatible as sources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span>
      r = o.source(data)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p> $(‘#’ + o.htmlID).html  templater(r.x, r.y, r.z, ‘raw’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      p = <span class="hljs-literal">undefined</span>
      m = <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>get the sensor data and pass to conditioner</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      r = Seen.P(r.x, r.y, r.z)
      r.subtract o.bias
      dataCondition.curValue = r.copy()
      dataCondition.cookedValue = r.copy()
      i = <span class="hljs-number">0</span>
      <span class="hljs-keyword">while</span> i &lt; o.calibrator.length
        o.calibrator[i] dataCondition, calibrate, calibrating
        i++
      p = dataCondition.cookedValue
      <span class="hljs-keyword">if</span> recording
        readings.push <span class="hljs-keyword">new</span> reading(
          <span class="hljs-attribute">sensor</span>: o.sensor
          <span class="hljs-attribute">raw</span>: _.toArray(data))
      m = dataCondition.dataHistory
      o.viewer p.x, p.y, p.z
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">catch</span> error
      <span class="hljs-built_in">console</span>.log error
<span class="hljs-function">
<span class="hljs-title">setBackgroundColor</span> = <span class="hljs-params">(color)</span> -&gt;</span>
  <span class="hljs-built_in">document</span>.documentElement.style.background = color
  <span class="hljs-built_in">document</span>.body.style.background = color
  <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="-">*</h2>
<p>Convert byte buffer to hex string.
@param buffer - an Uint8Array
@param offset - byte offset
@param numBytes - number of bytes to read
@return string with hex representation of bytes</p>
<h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>hx = [
  <span class="hljs-string">'0'</span>
  <span class="hljs-string">'1'</span>
  <span class="hljs-string">'2'</span>
  <span class="hljs-string">'3'</span>
  <span class="hljs-string">'4'</span>
  <span class="hljs-string">'5'</span>
  <span class="hljs-string">'6'</span>
  <span class="hljs-string">'7'</span>
  <span class="hljs-string">'8'</span>
  <span class="hljs-string">'9'</span>
  <span class="hljs-string">'A'</span>
  <span class="hljs-string">'B'</span>
  <span class="hljs-string">'C'</span>
  <span class="hljs-string">'D'</span>
  <span class="hljs-string">'E'</span>
  <span class="hljs-string">'F'</span>
]
<span class="hljs-function">

<span class="hljs-title">bufferToHexStr</span> = <span class="hljs-params">(buffer, offset, numBytes)</span> -&gt;</span>
  hex = <span class="hljs-string">''</span>
  <span class="hljs-keyword">if</span> !numBytes
    numBytes = buffer.length
  <span class="hljs-keyword">if</span> !offset
    offset = <span class="hljs-number">0</span>
  i = <span class="hljs-number">0</span>
  <span class="hljs-keyword">while</span> i &lt; numBytes
    hex += byteToHexStr(buffer[offset + i]) + <span class="hljs-string">' '</span>
    ++i
  hex
<span class="hljs-function">
<span class="hljs-title">byteToHexStr</span> = <span class="hljs-params">(d)</span> -&gt;</span>
  lo = hx[d &amp; <span class="hljs-number">0xf</span>]
  hi = hx[(d &amp; <span class="hljs-number">0xf0</span>) &gt;&gt; <span class="hljs-number">4</span>]
  hi + lo</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="stoprecording">stopRecording</h2>
<p>halt the record session — no restart allowed
upload button remains enabled, reset button remains enabled</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">stopRecording</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> recording
    recording = <span class="hljs-literal">false</span>
    $(<span class="hljs-string">'#record'</span>).prop(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>).text(<span class="hljs-string">'finished'</span>).fadeTo <span class="hljs-number">200</span>, <span class="hljs-number">0.3</span>
  <span class="hljs-keyword">return</span>
<span class="hljs-function">
<span class="hljs-title">viewSensor</span> = <span class="hljs-params">(viewport, scaleFactor)</span> -&gt;</span>
  height = <span class="hljs-number">200</span>
  width = <span class="hljs-number">200</span>
  model = Seen.Models[<span class="hljs-string">'default'</span>]()
  scene = <span class="hljs-keyword">new</span> (Seen.Scene)(
    <span class="hljs-attribute">model</span>: model
    <span class="hljs-attribute">viewport</span>: Seen.Viewports.center(width, height))
  cubie = Seen.Shapes.cube().scale(<span class="hljs-number">0.25</span>)
<span class="hljs-function">
  <span class="hljs-title">spearPool</span> = <span class="hljs-params">(many)</span> -&gt;</span>
    i = <span class="hljs-literal">undefined</span>
    j = <span class="hljs-literal">undefined</span>
    shapes = <span class="hljs-keyword">new</span> Array(many)
    count = -<span class="hljs-number">1</span>
    colors = <span class="hljs-keyword">new</span> Array(many)
<span class="hljs-function">
    <span class="hljs-title">newArrow</span> = <span class="hljs-params">(model, x, y, z)</span> -&gt;</span>
      alphaDecay = <span class="hljs-number">255</span>
      count = count + <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> count == many
        count = <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span> shapes[count]
        model.remove shapes[count]
      shapes[count] = Seen.Shapes.arrow(<span class="hljs-number">1</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>).scale(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).translate(<span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>).scale(height * <span class="hljs-number">0.025</span>)
      model.add(shapes[count])
      shapes[count].bake()
      shapes[count].reset()</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>assign alpha to the arrows color</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      j = <span class="hljs-number">0</span>
      i = count
      <span class="hljs-keyword">while</span> i &lt; many
        <span class="hljs-keyword">if</span> shapes[i]
          shapes[i].fill colors[j++]
        i++
      i = <span class="hljs-number">0</span>
      <span class="hljs-keyword">while</span> i &lt; count
        <span class="hljs-keyword">if</span> shapes[i]
          shapes[i].fill colors[j++]
        i++
      shapes[count]

    i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> i &lt; many
      shapes[i] = Seen.Shapes.arrow(<span class="hljs-number">1</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>).scale(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).translate(<span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>).scale(height * <span class="hljs-number">0.025</span>)
      shapes[i].bake()
      colors[i] = <span class="hljs-keyword">new</span> (Seen.Material)(<span class="hljs-keyword">new</span> (Seen.Color)(<span class="hljs-number">255</span>, <span class="hljs-number">80</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span> - <span class="hljs-number">250</span> / many * i))
      i++
    newArrow
<span class="hljs-function">
  <span class="hljs-title">newValue</span> = <span class="hljs-params">(x, y, z)</span> -&gt;</span>
    p1 = Seen.P(x, y, z)
    spear = <span class="hljs-literal">undefined</span>
    pOriginal = p1.copy()
    pBar = Seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    m = <span class="hljs-literal">undefined</span>
    q = <span class="hljs-literal">undefined</span>
    cross = <span class="hljs-literal">undefined</span>
    dot = <span class="hljs-literal">undefined</span>
    leng = p1.magnitude()
    p1 = p1.normalize()
    pBar.add p1
    <span class="hljs-keyword">if</span> pBar.magnitude() &lt; <span class="hljs-number">0.000001</span>
      pBar = Seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) <span class="hljs-comment"># this is a 180 degree rotation, so use y axis as rotation vector ###</span>
    pBar.normalize()
    q = Seen.Quaternion.pointAngle(pBar, Math.PI)
    m = q.toMatrix()
    spear = spearFromPool(model, x, y, z).transform(m).scale(scaleFactor * leng)
    spear.fill <span class="hljs-keyword">new</span> (Seen.Material)(<span class="hljs-keyword">new</span> (Seen.Color)(<span class="hljs-number">255</span>, <span class="hljs-number">80</span>, <span class="hljs-number">255</span>))
    context = Seen.Context(viewport, scene) <span class="hljs-keyword">if</span> !context
    context.render()
    <span class="hljs-keyword">return</span>

  spearFromPool = <span class="hljs-keyword">new</span> spearPool(<span class="hljs-number">10</span>)
  cubie.fill <span class="hljs-keyword">new</span> (Seen.Material)(<span class="hljs-keyword">new</span> (Seen.Color)(<span class="hljs-number">25</span>, <span class="hljs-number">200</span>, <span class="hljs-number">200</span>, <span class="hljs-number">100</span>))
  model.add cubie
  newValue</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="subsection-state-routines-that-depend-on-hardware-and-update-the-view-or-data-structures">subsection State routines that depend on hardware and update the view or data structures</h2>
<p>calculations implemented as based on TI wiki pages
<a href="http://processors.wiki.ti.com/index.php/SensorTag_User_Guide">http://processors.wiki.ti.com/index.php/SensorTag_User_Guide</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>accelerometerHandler = readingHandler(
  <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'accel'</span>
  <span class="hljs-attribute">debias</span>: <span class="hljs-string">'calibrateAccel'</span>
  <span class="hljs-attribute">source</span>: sensortag.getAccelerometerValues
  <span class="hljs-attribute">units</span>: <span class="hljs-string">'G'</span>
  <span class="hljs-attribute">calibrator</span>: [
    calibratorAverage
    calibratorSmooth
  ]
  <span class="hljs-attribute">viewer</span>: viewSensor(<span class="hljs-string">'accel-view'</span>, <span class="hljs-number">0.4</span>)
  <span class="hljs-attribute">htmlID</span>: <span class="hljs-string">'AccelerometerData'</span>)

magnetometerHandler = readingHandler(
  <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'mag'</span>
  <span class="hljs-attribute">debias</span>: <span class="hljs-string">'calibrateMag'</span>
  <span class="hljs-attribute">calibrator</span>: [
    calibratorAverage
    calibratorSmooth
  ]
  <span class="hljs-attribute">source</span>: sensortag.getMagnetometerValues
  <span class="hljs-attribute">units</span>: <span class="hljs-string">'&amp;micro;T'</span>
  <span class="hljs-attribute">viewer</span>: viewSensor(<span class="hljs-string">'magnet-view'</span>, <span class="hljs-number">0.05</span>)
  <span class="hljs-attribute">htmlID</span>: <span class="hljs-string">'MagnetometerData'</span>)

gyroscopeHandler = readingHandler(
  <span class="hljs-attribute">sensor</span>: <span class="hljs-string">'gyro'</span>
  <span class="hljs-attribute">debias</span>: <span class="hljs-string">'calibrateGyro'</span>
  <span class="hljs-attribute">calibrator</span>: [
    calibratorAverage
    calibratorSmooth
  ]
  <span class="hljs-attribute">source</span>: sensortag.getGyroscopeValues
  <span class="hljs-attribute">viewer</span>: viewSensor(<span class="hljs-string">'gyro-view'</span>, <span class="hljs-number">0.005</span>)
  <span class="hljs-attribute">htmlID</span>: <span class="hljs-string">'GyroscopeData'</span>)

deviceIsReady = <span class="hljs-literal">false</span>
<span class="hljs-function"><span class="hljs-title">setSensor</span> = -&gt;</span>
  pageGen.activateSensorPage()
  <span class="hljs-keyword">if</span> deviceIsReady
    initializeSensorTag()
  initAll()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">adminDone</span>= -&gt;</span>
  buttonValueAdmin = buttonModelLogout
  setSensor()
  
pageGen = <span class="hljs-keyword">new</span> pages.Pages admin, sessionInfo</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="this-is-how-seen-exports-things-it-s-clean-we-use-it-as-example">this is how seen exports things — it’s clean.  we use it as example</h2>
<p>seen = {}
if window? then window.seen = seen # for the web
if module?.exports? then module.exports = seen # for node</p>
<h1 id="-">#</h1>
<h2 id="and-since-we-are-in-a-browser-">And since we are in a browser —-</h2>
<h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">window</span>.$=$
<span class="hljs-built_in">window</span>.sessionInfo = sessionInfo</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>generated by js2coffee 2.0.1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

$(<span class="hljs-built_in">document</span>).<span class="hljs-literal">on</span> <span class="hljs-string">'deviceready'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> !deviceIsReady
    initializeSensorTag()
  deviceIsReady = <span class="hljs-literal">true</span>

$ -&gt;
  setButtons()
  pageGen.renderPage adminDone
  <span class="hljs-keyword">if</span> $(<span class="hljs-string">'#console-log'</span>)?
    <span class="hljs-built_in">window</span>.<span class="hljs-built_in">console</span>=<span class="hljs-built_in">console</span> = <span class="hljs-keyword">new</span> Console(<span class="hljs-string">'console-log'</span>)
    stopDebug()
  setSensor()
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
